

<div
class="w-11/12 md:w-4/6 mx-auto my-5 h-4"
>
    @if(serverError()) {
        <p class="text-xl text-rouge text-center position-absolute">
            {{serverError()}}
        </p>
    }
</div>


<!-- New station Form -->

<section
class="w-11/12 md:w-4/6 mx-auto dark:text-gray-200"
>

    <h2
    class="text-md md:text-xl uppercase mb-15 dark:text-gray-200"
    >
        @if(stationToEdit()) {
            Modifier la borne
        } @else {
            Ajouter une borne
        }
    </h2>


    <form
    [formGroup]="form" 
    (ngSubmit)="submit()"
    class="w-full md:w-4/5 lg:w-3/5 mx-auto flex flex-col justify-center items-center"
    >   

        <!-- nom de la station -->
        <div
        class="w-full mb-2"
        >
            <label
            for="name"
            class="dark:text-gray-200"
            >
                Nom de la borne
            </label>
            <input
            formControlName="name"
            type="text"
            class="w-full rounded-xl border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
            placeholder="Nom de la borne" required
            />
            <div class="h-5 mt-1 text-sm">
                @let nameInput = form.controls.name;
                @if (nameInput.invalid && (nameInput.dirty || nameInput.touched)) {
                    @if (nameInput.hasError('required')) {
                        <span
                        class="text-rouge">
                            Veuillez donner un nom à la borne (ex: Borne de recharge)
                        </span>
                    }
                }
            </div>

        </div>


        <!-- localisation de la station -->
        <div
        class="w-full mb-2"
        >   
            @let locationStationIdInput = form.controls.locationStationId;

            <button
            (click)="isLocationModalOpen.set(true)"
            class="mb-2 cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200"
            >   
                @if(locationStationIdInput.value!) {
                    Changer la localisation
                } @else {
                    Choisir une localisation
                }
                
            </button>

            @if(locationAddress()) {
                <p
                class="font-bold dark:text-gray-200"
                >
                    Localisation: {{ locationAddress() }}
                </p>
            }

            
            <app-standard-modal  [(open)]="isLocationModalOpen">
                <h2
                ngProjectAs="card-title"
                class="text-sm md:text-md uppercase"
                >
                    Ajouter une localisation
                </h2>
                <div ngProjectAs="card-body">
                    <app-location-form (locationFormSubmit)="addNewLocation($event.location)"/>
                </div>
                <p ngProjectAs="card-footer" class="text-white"></p>
            </app-standard-modal>

            <label 
            for="name"
            class="hidden"
            >
                Localisation de la station
            </label>
            <input 
            formControlName="locationStationId" 
            type="text" 
            class="hidden" 
             required 
            />
            <div class="h-5 my-1 text-sm">
                @if (locationStationIdInput.invalid) {
                    @if (locationStationIdInput.hasError('required')) {
                        <span
                        class="text-rouge">
                            Veuillez renseigner la localisation de la borne
                        </span>
                    }
                }
            </div>
        </div>
 

        <!-- tarification -->
        <div
        class="w-full mb-2"
        >
            <label
            for="tarification"
            class="dark:text-gray-200"
            >
                Tarif horaire en €
            </label>
            <input
            formControlName="tarification"
            type="number"
            class="w-full rounded-xl border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
            required
            min="0"
            />
            <div class="h-5 mt-1 text-sm">
                @let tarificationInput = form.controls.tarification;
                @if (tarificationInput.invalid && (tarificationInput.touched)) {
                    @if (tarificationInput.hasError('required')) {
                        <span
                        class="text-rouge">
                            Veuillez renseigner le tarif de la borne
                        </span>
                    }
                    @if (tarificationInput.hasError('min')) {
                        <span
                        class="text-rouge">
                            Le tarif ne peut pas être négatif
                        </span>
                    }
                }
            </div>
        </div>



        <!-- Puissance de la borne -->
        <div
        class="w-full mb-4"
        >
            <label
            for="power"
            class="dark:text-gray-200"
            >
                Puissance de la borne
            </label>
            <select
            formControlName="power"
            name="power"
            class="w-full rounded-xl border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
            required
            >
                <option value="" disabled>Choisissez une puissance de borne</option>
                <option value="3,7 kVA">3,7 kVA</option>
                <option value="7,4 kVA">7,4 kVA</option>
                <option value="11 kVA">11 kVA</option>
                <option value="22 kVA">22 kVA</option>
            </select>
        </div>


        <!-- instructions -->
        <div
        class="w-full mb-4"
        >
            <label
            for="instruction"
            class="hidden"
            >
                Vos instructions pour accéder à la borne
            </label>
            <textarea
            formControlName="instruction"
            type="instruction"
            class="w-full rounded-xl border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
            placeholder="Vos instructions (optionel)"
            >
            </textarea>

        </div>


        <!-- Borne sur pieds ou un mur -->
        <div
        class="w-full mb-4 flex flex-col"
        >
            <label 
            for="freeStanding"	 
            class="hidden"
            >
                Support de la borne
            </label>
            <input 
            formControlName="freeStanding" 
            type="checkbox" 
            name="freeStanding"
            class="mb-1 rounded-xl border border-noir accent-vert text-vert px-4 py-2 focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent"
            />
            <span class="text-gray-700 dark:text-gray-200">
                Borne sur pied (décocher si fixée au mur)
            </span>
        </div>


        <!-- Borne sur pieds ou un mur -->
        <div
        class="w-full mb-4 flex flex-col"
        >
            <label
            for="available"
            class="hidden"
            >
                Borne disponible à la location
            </label>
            <input
            formControlName="available"
            type="checkbox"
            name="available"
            class="mb-1 rounded-xl border border-noir accent-vert text-vert px-4 py-2 focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600"
            />
            <span class="text-gray-700 dark:text-gray-200">
                Borne disponible à la location (par défaut oui, sinon décochez cette case)
            </span>
        </div>

        <!-- Exceptions de disponibilité (seulement en mode édition) -->
        @if(stationToEdit()) {
            <div class="w-full mb-4 border-t border-gray-300 pt-4 dark:border-gray-600">
                <h3 class="text-md font-semibold mb-3 dark:text-gray-200">
                    Exceptions de disponibilité
                </h3>
                <p class="text-sm text-gray-600 mb-3 dark:text-gray-400">
                    Définissez les créneaux où votre borne n'est PAS disponible à la réservation.
                </p>

                <!-- Liste des exceptions existantes -->
                @if(stationExceptions().length > 0) {
                    <div class="mb-4 space-y-2">
                        @for(exception of stationExceptions(); track exception.id) {
                            <div class="flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                                <span class="dark:text-gray-200">
                                    {{ getDayLabel(exception.day) }} : {{ exception.startLocalTime }} - {{ exception.endLocalTime }}
                                </span>
                                <button
                                    type="button"
                                    (click)="deleteException(exception.id)"
                                    class="text-rouge hover:text-red-700 cursor-pointer"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        }
                    </div>
                } @else {
                    <p class="text-sm text-gray-500 mb-3 italic dark:text-gray-400">
                        Aucune exception définie. La borne est disponible tous les jours.
                    </p>
                }

                <!-- Bouton pour ajouter une exception -->
                <button
                    type="button"
                    (click)="isExceptionModalOpen.set(true)"
                    class="cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200"
                >
                    + Ajouter une exception
                </button>

                <!-- Modal pour ajouter une exception -->
                <app-standard-modal [(open)]="isExceptionModalOpen">
                    <h2
                        ngProjectAs="card-title"
                        class="text-sm md:text-md uppercase"
                    >
                        Ajouter une exception de disponibilité
                    </h2>
                    <div ngProjectAs="card-body">
                        <form [formGroup]="exceptionForm" (ngSubmit)="addException()" class="space-y-4">
                            <!-- Jour de la semaine -->
                            <div>
                                <label for="exception-day" class="block mb-1 dark:text-gray-200">Jour de la semaine</label>
                                <select
                                    id="exception-day"
                                    formControlName="day"
                                    class="w-full rounded-xl border border-noir p-2 focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
                                >
                                    <option value="" disabled>Choisissez un jour</option>
                                    @for(day of daysOfWeek; track day.value) {
                                        <option [value]="day.value">{{ day.label }}</option>
                                    }
                                </select>
                            </div>

                            <!-- Heure de début -->
                            <div>
                                <label for="exception-start-time" class="block mb-1 dark:text-gray-200">Heure de début</label>
                                <input
                                    id="exception-start-time"
                                    type="time"
                                    formControlName="startLocalTime"
                                    class="w-full rounded-xl border border-noir p-2 focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
                                />
                            </div>

                            <!-- Heure de fin -->
                            <div>
                                <label for="exception-end-time" class="block mb-1 dark:text-gray-200">Heure de fin</label>
                                <input
                                    id="exception-end-time"
                                    type="time"
                                    formControlName="endLocalTime"
                                    class="w-full rounded-xl border border-noir p-2 focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
                                />
                            </div>

                            <button
                                type="submit"
                                class="w-full cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200"
                            >
                                Ajouter l'exception
                            </button>
                        </form>
                    </div>
                    <p ngProjectAs="card-footer" class="text-white"></p>
                </app-standard-modal>
            </div>
        }

        <button
        type="submit"
        [disabled]="form.invalid"
        class="mt-8 uppercase cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200"
        >
            @if(stationToEdit()) {
                Modifier la borne
            } @else {
                Ajouter votre borne
            }
        </button>

    </form>
</section>  
