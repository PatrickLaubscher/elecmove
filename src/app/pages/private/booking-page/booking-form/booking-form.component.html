

<form
[formGroup]="form" 
(ngSubmit)="handleSubmit()"
class="w-full md:w-4/5 lg:w-3/5 mx-auto flex flex-col justify-center items-center"
>   

    <!-- borne choisie -->
    <div
    class="w-full mb-3"
    >
        @let stationIdInput = form.controls.stationId;

        <label 
        for="name"
        class="hidden"
        >
            Id de la borne
        </label>
        <input 
        formControlName="stationId" 
        type="text" 
        class="hidden" 
            required 
        />

        @if(isLoadingStation()) {
            <p class="dark:text-gray-200">Chargement de la borne...</p>
        } @else {
            <div class="mt-2 p-3 bg-gray-100 rounded-md dark:bg-gray-800 dark:border-gray-600">
                <p class="dark:text-gray-200"><strong>Nom :</strong> {{ station()?.name }}</p>
                <p class="dark:text-gray-200"><strong>Adresse :</strong> {{ station()?.location?.address }}</p>
                <p class="dark:text-gray-200"><strong>Puissance :</strong> {{ station()?.power }}</p>
                <p class="dark:text-gray-200"><strong>Type :</strong> {{ this.stationType }}</p>
                <hr
                class="my-2">
                <p class="dark:text-gray-200"><strong>Tarif horaire :</strong> {{ station()?.tarification }} €</p>
            </div>
        }
 

        <div class="flex flex-wrap gap-2">
            <button
            type="button"
            (click)="isMapModalOpen.set(true)"
            class="cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200"
            >
                @if(stationId()!) {
                    Choisir une nouvelle borne
                } @else {
                    Choisir une borne
                }
            </button>

            <button
            type="button"
            (click)="isFavoritesModalOpen.set(true)"
            class="cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200 flex items-center gap-2"
            >
                <svg
                class="size-5"
                viewBox="0 0 34 34"
                fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M23.8531 6.375C24.6267 6.37435 25.3926 6.52814 26.106 6.82735C26.8194 7.12657 27.4659 7.56519 28.0075 8.1175C29.1236 9.25053 29.7492 10.7771 29.7492 12.3675C29.7492 13.9579 29.1236 15.4845 28.0075 16.6175L17 27.7631L5.99251 16.6175C4.87644 15.4845 4.25084 13.9579 4.25084 12.3675C4.25084 10.7771 4.87644 9.25053 5.99251 8.1175C6.53448 7.56559 7.18099 7.1272 7.89429 6.82794C8.60758 6.52868 9.37335 6.37455 10.1469 6.37455C10.9204 6.37455 11.6862 6.52868 12.3995 6.82794C13.1128 7.1272 13.7593 7.56559 14.3013 8.1175L17 10.88L19.6881 8.13875C20.2281 7.57986 20.8753 7.13561 21.5909 6.83256C22.3066 6.52951 23.076 6.37389 23.8531 6.375ZM23.8531 4.25C22.7966 4.24911 21.7505 4.45916 20.7763 4.86785C19.802 5.27654 18.9191 5.87563 18.1794 6.63L17 7.82L15.8206 6.63C15.08 5.87699 14.1969 5.27894 13.2228 4.87071C12.2487 4.46247 11.2031 4.25223 10.1469 4.25223C9.09069 4.25223 8.04506 4.46247 7.07096 4.87071C6.09685 5.27894 5.21375 5.87699 4.47313 6.63C2.96638 8.16386 2.12213 10.228 2.12213 12.3781C2.12213 14.5282 2.96638 16.5924 4.47313 18.1263L17 30.8125L29.5269 18.1263C31.0336 16.5924 31.8779 14.5282 31.8779 12.3781C31.8779 10.228 31.0336 8.16386 29.5269 6.63C28.7861 5.87707 27.903 5.27891 26.929 4.87033C25.9549 4.46175 24.9094 4.25088 23.8531 4.25Z"
                class="fill-current"/>
                </svg>
                Mes favoris
            </button>
        </div>

        <!-- Modal favoris -->
        <app-standard-modal [(open)]="isFavoritesModalOpen">
            <h2
            ngProjectAs="card-title"
            class="text-sm md:text-md uppercase dark:text-gray-200"
            >
                Choisir une borne favorite
            </h2>
            <div ngProjectAs="card-body" class="max-h-96 overflow-y-auto">
                @if(favoriteStations.isLoading()) {
                    <p class="dark:text-gray-200">Chargement des favoris...</p>
                } @else if(favoriteStations.value()?.length === 0) {
                    <p class="dark:text-gray-200">Vous n'avez aucune borne en favoris.</p>
                } @else {
                    <ul class="space-y-3">
                        @for(fav of favoriteStations.value(); track fav.station.id) {
                            <li
                            (click)="selectFavoriteStation(fav)"
                            class="p-3 border border-noir dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            >
                                <div class="flex items-center gap-3">
                                    <img
                                    src="svg/charging-station.svg"
                                    alt="Borne"
                                    class="size-8 dark:invert"
                                    />
                                    <div>
                                        <p class="font-semibold dark:text-gray-200">{{ fav.station.name }}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">
                                            {{ fav.station.location.address }}, {{ fav.station.location.city }}
                                        </p>
                                        <p class="text-sm text-vert">{{ fav.station.tarification }} €/h</p>
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                }
            </div>
            <p ngProjectAs="card-footer" class="text-white"></p>
        </app-standard-modal>


        <app-standard-modal  [(open)]="isMapModalOpen">
            <h2
            ngProjectAs="card-title"
            class="text-sm md:text-md uppercase"
            >
                Choisir une borne de recharge
            </h2>
            <div ngProjectAs="card-body">
                <app-interactive-map [isMapModalOpen]="isMapModalOpen()" (closingModal)="isMapModalOpen.set(false)"/>
            </div>
            <p ngProjectAs="card-footer" class="text-white"></p>
        </app-standard-modal>
        
        
        <div class="h-5 my-1 text-sm">
            @if (stationIdInput.invalid) {
                @if (stationIdInput.hasError('required')) {
                    <span
                    class="text-rouge">
                        Veuillez choisir une borne de recharge
                    </span>
                }
            }
        </div>

    </div>



    <!-- date de la réservation -->
    <div
    class="w-1/2 self-start"
    >
        <label
        for="date"
        class="dark:text-gray-200"
        >
            Date de la réservation
        </label>
        <input
        formControlName="date"
        type="date"
        [min]="today"
        class="w-full rounded-xl border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
        required
        />
        <div class="h-5 mt-1 text-sm">
            @let dateInput = form.controls.date;
            @if (dateInput.invalid && (dateInput.touched)) {
                @if (dateInput.hasError('required')) {
                    <span
                    class="text-rouge">
                        Veuillez choisir une date de réservation
                    </span>
                }
            }
        </div>
    </div>

    <div class="grid grid-cols-2 w-full gap-2">
        <!-- heure de début -->
        <div
        class=""
        >
            <label
            for="startTime"
            class="dark:text-gray-200"
            >
                Heure de début
            </label>
            <input
            id="startTime"
            formControlName="startTime"
            type="time"
            step="1800"
            [min]="minStartTime()"
            class="w-full rounded-xl border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
            required
            />
        </div>

        <!-- heure de fin -->
        <div
        class=""
        >
            <label
            for="endTime"
            class="dark:text-gray-200"
            >
                Heure de fin
            </label>
            <input
            id="endTime"
            formControlName="endTime"
            type="time"
            step="1800"
            class="w-full rounded-xl border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
            required
            />
        </div>
    </div>
    <div class="h-5 mt-1 text-sm">
            @let startTimeInput = form.controls.startTime;
            @if (startTimeInput.invalid && (startTimeInput.touched)) {
                @if (startTimeInput.hasError('required')) {
                    <span
                    class="text-rouge">
                        Veuillez choisir une heure début
                    </span>
                }
            }
            @let endTimeInput = form.controls.endTime;
                @if (endTimeInput.invalid && (endTimeInput.touched)) {
                    @if (endTimeInput.hasError('required')) {
                        <span
                        class="text-rouge">
                            Veuillez choisir une heure de fin
                        </span>
                    }
            }
            @if (form.hasError('endBeforeStart') && form.touched) {
                <span class="text-rouge text-sm">L'heure de fin doit être après l'heure de début</span>
            }
            @if (form.value.date === today && form.hasError('startTimeInPast')) {
                <span class="text-gray-600 block text-sm">
                    Réservation possible à partir de {{ minStartTime() }} aujourd'hui
                </span>
            }
    </div>


    <!-- voiture à recharger -->
    <div
    class="w-full my-3"
    >
        @let carIdInput = form.controls.carId;

        <label
        for="carId"
        class="dark:text-gray-200"
        >
            Votre véhicule à recharger
        </label>
        <select
        formControlName="carId"
        name="carId"
        class="w-full rounded-xl mb-1 border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200"
        required
        >   
            <option value="" disabled>Choisissez une voiture</option>
            @if(cars.hasValue()) {
                @for(car of cars.value(); track car.id) {
                    <option 
                    value="{{car.id}}" 
                    >
                    {{car.brand}} - {{car.type}}
                    </option>    
                }
            }
        </select>



        <button
        (click)="isCarModalOpen.set(true)"
        class="mb-2 cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200"
        >   
            + Ajouter une voiture à votre liste
        </button>
        
        <app-standard-modal  [(open)]="isCarModalOpen">
            <h2
            ngProjectAs="card-title"
            class="text-sm md:text-md uppercase"
            >
                Rajouter une nouvelle voiture
            </h2>
            <div ngProjectAs="card-body">
                <app-car-form [isCarModalOpen]="isCarModalOpen()" (closingModal)="isCarModalOpen.set(false)"/>
            </div>
            <p ngProjectAs="card-footer" class="text-white"></p>
        </app-standard-modal>

        <div class="h-5 my-1 text-sm">
            @if (carIdInput.invalid) {
                @if (carIdInput.hasError('required')) {
                    <span
                    class="text-rouge">
                        Veuillez choisir le véhicule à recharger
                    </span>
                }
            }
        </div>
    </div>

    <!-- récapitulatif durée/prix -->
    <div
    class="w-full rounded-xl text-lg p-2 border border-noir focus:outline-none focus:ring-2 focus:ring-vert focus:border-transparent dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200"
    >
        <p class="dark:text-gray-200">
            Durée totale : {{timeConversion.formatDuration(preBookingEstimate().bookingDuration)}}
        </p>
        <p class="dark:text-gray-200">
            Coût de la réservation : {{preBookingEstimate().bookingEstimatePrice}} € HT
        </p>
    </div>

    <button
    type="submit"
    [disabled]="form.invalid"
    class="mt-8 uppercase cursor-pointer bg-noir text-blanc px-4 py-2 rounded-md border border-vert ease-in-out duration-200 hover:drop-shadow-2xl hover:text-vert dark:bg-gray-800 dark:text-gray-200"
    >
        Confirmer votre réservation
    </button>

</form>

